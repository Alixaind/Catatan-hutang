<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kirim Notifikasi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <style> @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap'); body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-50">
	<div id="notificationContainer" class="fixed top-4 right-4 space-y-3 z-50 w-full max-w-xs"></div>
    <div class="container mx-auto max-w-lg p-4 sm:p-6">
        <header class="flex items-center mb-6">
            <a href="dashboard.html" class="p-2 rounded-md hover:bg-gray-200 mr-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
            </a>
            <h1 class="text-2xl font-bold text-gray-900">Kirim Notifikasi</h1>
        </header>

        <main class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-4">
            <div>
                <label for="targetSelect" class="block text-sm font-medium text-gray-700">Kirim Ke</label>
                <select id="targetSelect" class="mt-1 w-full p-3 border rounded-lg bg-white">
                    <option value="" disabled selected>Pilih target...</option>
                    <optgroup label="Grup">
                        <option value="semua_nasabah">Semua Nasabah Saya</option>
                    </optgroup>
                    <optgroup label="Perorangan" id="nasabahList"></optgroup>
                </select>
            </div>
            <div>
                <label for="notifTitle" class="block text-sm font-medium text-gray-700">Judul</label>
                <input type="text" id="notifTitle" class="mt-1 w-full p-3 border rounded-lg" placeholder="Judul pesan...">
            </div>
            <div>
                <label for="notifMessage" class="block text-sm font-medium text-gray-700">Isi Pesan</label>
                <textarea id="notifMessage" rows="5" class="mt-1 w-full p-3 border rounded-lg" placeholder="Tulis pesan Anda di sini..."></textarea>
            </div>
            <button id="sendBtn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700">Kirim Notifikasi</button>
        </main>
    </div>

<script>
    const { Client, Account, Databases, ID, Query } = Appwrite;
    const client = new Client();
    client.setEndpoint('https://fra.cloud.appwrite.io/v1').setProject('68b92f2c0028afdfe9af');
    const account = new Account(client);
    const databases = new Databases(client);

    const APPWRITE_DATABASE_ID = "68b93734003a60307a8c";
    const APPWRITE_USERS_PUBLIC_COLLECTION_ID = "users_public";
    const APPWRITE_NASABAH_COLLECTION_ID = "user_nasabah";
    const APPWRITE_NOTIFIKASI_COLLECTION_ID = "notifikasi";

    const targetSelect = document.getElementById('targetSelect');
    const nasabahList = document.getElementById('nasabahList');
    const sendBtn = document.getElementById('sendBtn');
    let currentUserId = null;

    // Fungsi untuk menampilkan notifikasi popup (toast)
    function showToast(message, type = 'success') {
        const container = document.getElementById('notificationContainer');
        if (!container) return;
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-blue-500' : 'bg-red-500';
        toast.className = `p-4 rounded-lg text-white shadow-lg ${bgColor}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.transition = 'opacity 0.5s ease-out';
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 500);
        }, 5000);
    }

    // Fungsi untuk 'mendengarkan' notifikasi baru dari Appwrite
    function listenForNotifications(userId) {
        client.subscribe(`databases.${APPWRITE_DATABASE_ID}.collections.${APPWRITE_NOTIFIKASI_COLLECTION_ID}.documents`, response => {
            if (response.events.includes('databases.*.collections.*.documents.*.create')) {
                const newNotification = response.payload;
                if (newNotification.recipientId === userId) {
                    showToast(`Pesan baru: ${newNotification.title}`);
                }
            }
        });
    }

    async function initializePage() {
        try {
            const user = await account.get();
            currentUserId = user.$id;
            
            // Panggil fungsi untuk mengisi dropdown nasabah
            populateNasabah();

            // Panggil fungsi pendengar notifikasi
            listenForNotifications(currentUserId);

        } catch (error) {
            console.error(error);
            window.location.href = "index.html";
        }
    }

    async function populateNasabah() {
        try {
            const res = await databases.listDocuments(APPWRITE_DATABASE_ID, APPWRITE_NASABAH_COLLECTION_ID, [Query.equal("user_id", currentUserId)]);
            for (const rel of res.documents) {
                const userDoc = await databases.getDocument(APPWRITE_DATABASE_ID, APPWRITE_USERS_PUBLIC_COLLECTION_ID, rel.nasabah_id);
                const option = document.createElement('option');
                option.value = userDoc.$id;
                option.textContent = userDoc.name;
                nasabahList.appendChild(option);
            }
        } catch (error) {
            console.error("Gagal memuat daftar nasabah:", error);
        }
    }

    sendBtn.addEventListener('click', async () => {
        const target = targetSelect.value;
        const title = document.getElementById('notifTitle').value;
        const message = document.getElementById('notifMessage').value;

        if (!target || !title || !message) {
            return showToast('Harap isi semua kolom.', 'error');
        }

        sendBtn.disabled = true;
        sendBtn.textContent = 'Mengirim...';

        try {
            let recipientIds = [];
            if (target === 'semua_nasabah') {
                const nasabahRelations = await databases.listDocuments(APPWRITE_DATABASE_ID, APPWRITE_NASABAH_COLLECTION_ID, [Query.equal('user_id', currentUserId)]);
                recipientIds = nasabahRelations.documents.map(doc => doc.nasabah_id);
            } else {
                recipientIds.push(target);
            }

            if (recipientIds.length === 0) {
                 throw new Error("Tidak ada nasabah yang ditemukan.");
            }

            const creationPromises = recipientIds.map(recipientId => {
                return databases.createDocument(APPWRITE_DATABASE_ID, APPWRITE_NOTIFIKASI_COLLECTION_ID, ID.unique(), {
                    title, initialMessage: message, senderId: currentUserId, recipientId, lastActivity: new Date().toISOString()
                });
            });

            await Promise.all(creationPromises);
            showToast(`Notifikasi berhasil dikirim ke ${recipientIds.length} orang.`);
            setTimeout(() => { window.location.href = 'Inbox.html'; }, 1500);

        } catch (error) {
            showToast('Gagal mengirim: ' + error.message, 'error');
        } finally {
            sendBtn.disabled = false;
            sendBtn.textContent = 'Kirim Notifikasi';
        }
    });

    document.addEventListener('DOMContentLoaded', initializePage);
</script>
</body>
</html>